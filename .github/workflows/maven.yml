name: Build Staff++ Plugin

on:
  push:
    branches:
      - main
  pull_request:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # Setup Java
      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: 17
          distribution: temurin

      # Create temporary Maven settings with custom local repo
      - name: Setup Maven settings
        run: |
          mkdir -p $HOME/.m2
          cat > $HOME/.m2/settings.xml <<'EOF'
          <settings>
            <localRepository>${HOME}/.m2/repo</localRepository>
            <profiles>
              <profile>
                <id>temp-repo</id>
                <repositories>
                  <repository>
                    <id>codemc-repo</id>
                    <url>https://repo.codemc.io/repository/maven-public/</url>
                  </repository>
                  <repository>
                    <id>scarsz-nexus</id>
                    <url>https://nexus.scarsz.me/content/groups/public/</url>
                  </repository>
                </repositories>
              </profile>
            </profiles>
            <activeProfiles>
              <activeProfile>temp-repo</activeProfile>
            </activeProfiles>
          </settings>
          EOF

      # Install missing dependencies from libs folder
      - name: Install local JAR dependencies
        run: |
          for f in libs/*.jar; do
            # extract groupId, artifactId, version from file name convention if needed
            mvn install:install-file -Dfile="$f" -DgroupId=local -DartifactId=$(basename "$f" .jar) -Dversion=1.0 -Dpackaging=jar
          done

      # Build the project
      - name: Build with Maven
        run: mvn clean package -s $HOME/.m2/settings.xml
